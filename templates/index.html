<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>우리 가족 통합 일정표</title>
  <style>
    :root {
      --header-bg: #2C3E50;
      --today-bg: #F1C40F;
      --cell-bg: #ECF0F1;
      --time-bg: #BDC3C7;
      --border: #ddd;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Malgun Gothic", "Apple SD Gothic Neo", sans-serif; background: #ecf0f1; }
    .header {
      background: var(--header-bg);
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .nav { display: flex; align-items: center; gap: 8px; }
    .nav button {
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #34495e;
      color: #fff;
    }
    .nav button:hover { background: #1abc9c; }
    .nav .week-label {
      font-size: 16px;
      font-weight: bold;
      min-width: 180px;
      text-align: center;
    }
    .writers { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .writers span { margin-right: 4px; font-size: 13px; }
    .writers label {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
    }
    .writers input { margin-right: 4px; }
    .container { padding: 16px; overflow-x: auto; }
    .grid-wrap { overflow-y: auto; max-height: calc(100vh - 140px); }
    table.calendar {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      background: #fff;
      table-layout: fixed;
    }
    table.calendar th, table.calendar td { border: 1px solid var(--border); padding: 4px; vertical-align: top; }
    table.calendar th.day-header {
      background: var(--cell-bg);
      font-weight: bold;
      text-align: center;
      padding: 8px;
      font-size: 12px;
    }
    table.calendar th.day-header.today { background: var(--today-bg); }
    table.calendar th.time-col {
      width: 64px;
      background: var(--time-bg);
      font-size: 11px;
      text-align: center;
      padding: 8px 4px;
    }
    table.calendar td.cell {
      min-height: 48px;
      height: 48px;
      cursor: pointer;
      transition: background 0.15s;
    }
    table.calendar td.cell:hover { background: #e8f4f8; }
    .event-btn {
      display: block;
      width: 100%;
      margin: 2px 0;
      padding: 4px 6px;
      font-size: 11px;
      text-align: left;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .event-btn:hover { opacity: 0.9; filter: brightness(0.95); }
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      min-width: 320px;
      max-width: 90vw;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal h3 { margin-top: 0; margin-bottom: 16px; font-size: 16px; }
    .modal label { display: block; margin-bottom: 4px; font-size: 13px; }
    .modal input[type="text"], .modal select { width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; }
    .modal .who-group { margin-bottom: 12px; }
    .modal .who-group label { display: inline-flex; margin-right: 8px; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .modal .btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
    .modal .btns button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .modal .btns .submit { background: #3498db; color: #fff; }
    .modal .btns .submit:hover { background: #2980b9; }
    .modal .btns .cancel { background: #95a5a6; color: #fff; }
    .modal .btns .cancel:hover { background: #7f8c8d; }
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background: #27ae60;
      color: #fff;
      border-radius: 6px;
      display: none;
      z-index: 1001;
    }
    .toast.show { display: block; }
  </style>
</head>
<body>
  <header class="header">
    <div class="nav">
      <button type="button" id="btnPrevMonth">&laquo;</button>
      <button type="button" id="btnPrevWeek">&lt;</button>
      <span class="week-label" id="weekLabel"></span>
      <button type="button" id="btnNextWeek">&gt;</button>
      <button type="button" id="btnNextMonth">&raquo;</button>
    </div>
    <div class="writers">
      <span>작성자:</span>
      <label style="background:#BBDEFB;"><input type="radio" name="writer" value="아빠" checked> 아빠</label>
      <label style="background:#F8BBD0;"><input type="radio" name="writer" value="엄마"> 엄마</label>
      <label style="background:#FFE0B2;"><input type="radio" name="writer" value="첫째"> 첫째</label>
      <label style="background:#C8E6C9;"><input type="radio" name="writer" value="둘째"> 둘째</label>
    </div>
  </header>

  <div class="container">
    <div class="grid-wrap">
      <table class="calendar" id="calendarTable">
        <thead>
          <tr>
            <th class="time-col">시간</th>
            <th class="day-header" data-day="0"></th>
            <th class="day-header" data-day="1"></th>
            <th class="day-header" data-day="2"></th>
            <th class="day-header" data-day="3"></th>
            <th class="day-header" data-day="4"></th>
            <th class="day-header" data-day="5"></th>
            <th class="day-header" data-day="6"></th>
          </tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </div>
  </div>

  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <h3 id="modalTitle">일정 추가</h3>
      <label>일정 내용</label>
      <input type="text" id="inputContent" placeholder="예: 영어 수업">
      <label>종료 시간 (여러 시간 통합 시, 예: 12:00) — 1시간만 쓰려면 비우기</label>
      <input type="text" id="inputEndTime" placeholder="예: 12:00 또는 12">
      <div class="who-group">
        <span>작성자:</span>
        <label style="background:#BBDEFB;"><input type="radio" name="modalWriter" value="아빠" checked> 아빠</label>
        <label style="background:#F8BBD0;"><input type="radio" name="modalWriter" value="엄마"> 엄마</label>
        <label style="background:#FFE0B2;"><input type="radio" name="modalWriter" value="첫째"> 첫째</label>
        <label style="background:#C8E6C9;"><input type="radio" name="modalWriter" value="둘째"> 둘째</label>
      </div>
      <div class="btns">
        <button type="button" class="cancel" id="btnModalCancel">취소</button>
        <button type="button" class="submit" id="btnModalSubmit">추가</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const DAYS_KR = ["일", "월", "화", "수", "목", "금", "토"];
    const TIMES = ["06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","24:00"];
    const MEMBERS = {"아빠":"#BBDEFB","엄마":"#F8BBD0","첫째":"#FFE0B2","둘째":"#C8E6C9"};

    let viewDate = null;
    let calendarData = {};
    let addCell = null;

    function setViewDateToWeekStart(d) {
      const date = new Date(d);
      const day = date.getDay();
      const diff = date.getDate() - day;
      viewDate = new Date(date.getFullYear(), date.getMonth(), diff, 0, 0, 0, 0);
    }

    function formatDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + day;
    }

    function getWeekLabel() {
      const mid = new Date(viewDate);
      mid.setDate(mid.getDate() + 3);
      const y = mid.getFullYear();
      const m = mid.getMonth() + 1;
      const first = new Date(y, mid.getMonth(), 1);
      const firstSun = first.getDate() - first.getDay();
      const weekNum = Math.ceil((mid.getDate() - firstSun + 1) / 7);
      return y + '년 ' + String(m).padStart(2, '0') + '월 ' + weekNum + '주차';
    }

    function isToday(d) {
      const t = new Date();
      return d.getFullYear() === t.getFullYear() && d.getMonth() === t.getMonth() && d.getDate() === t.getDate();
    }

    async function fetchData() {
      const r = await fetch('/api/data');
      calendarData = await r.json();
      return calendarData;
    }

    function renderHeaders() {
      const thead = document.querySelector('#calendarTable thead tr');
      const timeCol = thead.querySelector('.time-col');
      thead.innerHTML = '';
      thead.appendChild(timeCol);
      for (let j = 0; j < 7; j++) {
        const d = new Date(viewDate);
        d.setDate(d.getDate() + j);
        const th = document.createElement('th');
        th.className = 'day-header' + (isToday(d) ? ' today' : '');
        th.textContent = DAYS_KR[j] + '(' + formatDate(d).slice(5).replace('-', '/') + ')';
        th.setAttribute('data-day', j);
        thead.appendChild(th);
      }
      document.getElementById('weekLabel').textContent = getWeekLabel();
    }

    function renderBody() {
      const tbody = document.getElementById('calendarBody');
      tbody.innerHTML = '';
      for (let i = 0; i < TIMES.length; i++) {
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.className = 'time-col';
        th.textContent = TIMES[i];
        tr.appendChild(th);
        for (let j = 0; j < 7; j++) {
          const d = new Date(viewDate);
          d.setDate(d.getDate() + j);
          const dateStr = formatDate(d);
          const key = dateStr + '_' + TIMES[i];
          const td = document.createElement('td');
          td.className = 'cell';
          td.dataset.row = i;
          td.dataset.col = j;
          const events = calendarData[key];
          if (events && Array.isArray(events)) {
            events.forEach((ev, idx) => {
              if (typeof ev !== 'object') return;
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'event-btn';
              btn.textContent = ev.text || '';
              btn.style.background = ev.bg || '#ddd';
              btn.dataset.key = key;
              btn.dataset.index = idx;
              btn.dataset.eventId = ev.event_id || '';
              btn.addEventListener('click', function(e) { e.stopPropagation(); deleteEvent(this); });
              td.appendChild(btn);
            });
          }
          td.addEventListener('click', function(e) {
            if (e.target.classList.contains('event-btn')) return;
            openAddModal(parseInt(this.dataset.row, 10), parseInt(this.dataset.col, 10));
          });
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    function openAddModal(row, col) {
      addCell = { row, col };
      const d = new Date(viewDate);
      d.setDate(d.getDate() + col);
      const dateStr = formatDate(d);
      document.getElementById('modalTitle').textContent = '일정 추가 — ' + dateStr + ' ' + TIMES[row];
      document.getElementById('inputContent').value = '';
      document.getElementById('inputEndTime').value = '';
      document.getElementById('addModal').classList.add('show');
      document.getElementById('inputContent').focus();
    }

    function closeAddModal() {
      document.getElementById('addModal').classList.remove('show');
      addCell = null;
    }

    async function submitAdd() {
      if (!addCell) return;
      const content = document.getElementById('inputContent').value.trim();
      if (!content) return;
      const endTime = document.getElementById('inputEndTime').value.trim();
      const who = document.querySelector('input[name="modalWriter"]:checked').value;
      const d = new Date(viewDate);
      d.setDate(d.getDate() + addCell.col);
      const dateStr = formatDate(d);

      const res = await fetch('/api/event', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          date_str: dateStr,
          time_index: addCell.row,
          end_time: endTime,
          who: who,
          content: content
        })
      });
      const result = await res.json();
      if (result.ok) {
        calendarData = result.data;
        closeAddModal();
        renderBody();
        showToast('일정이 추가되었습니다.');
      } else {
        showToast('저장 실패.');
      }
    }

    async function deleteEvent(btn) {
      const key = btn.dataset.key;
      const index = parseInt(btn.dataset.index, 10);
      const eventId = btn.dataset.eventId || '';
      if (!confirm('선택한 일정을 삭제할까요?')) return;

      const res = await fetch('/api/event/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(eventId ? { event_id: eventId } : { key, index })
      });
      const result = await res.json();
      if (result.ok) {
        calendarData = result.data;
        renderBody();
        showToast('삭제되었습니다.');
      } else {
        showToast('삭제 실패.');
      }
    }

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2000);
    }

    function goPrevWeek() {
      viewDate.setDate(viewDate.getDate() - 7);
      renderHeaders();
      renderBody();
    }
    function goNextWeek() {
      viewDate.setDate(viewDate.getDate() + 7);
      renderHeaders();
      renderBody();
    }
    function goPrevMonth() {
      viewDate.setMonth(viewDate.getMonth() - 1);
      renderHeaders();
      renderBody();
    }
    function goNextMonth() {
      viewDate.setMonth(viewDate.getMonth() + 1);
      renderHeaders();
      renderBody();
    }

    document.getElementById('btnPrevMonth').addEventListener('click', goPrevMonth);
    document.getElementById('btnPrevWeek').addEventListener('click', goPrevWeek);
    document.getElementById('btnNextWeek').addEventListener('click', goNextWeek);
    document.getElementById('btnNextMonth').addEventListener('click', goNextMonth);
    document.getElementById('btnModalCancel').addEventListener('click', closeAddModal);
    document.getElementById('btnModalSubmit').addEventListener('click', submitAdd);
    document.getElementById('inputContent').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') submitAdd();
    });

    (async function init() {
      setViewDateToWeekStart(new Date());
      await fetchData();
      renderHeaders();
      renderBody();
    })();
  </script>
</body>
</html>
