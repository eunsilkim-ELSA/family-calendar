<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ORGANIZING OUR FAMILY</title>
  <style>
    :root {
      --header-bg: #2C3E50;
      --today-bg: #F1C40F;
      --cell-bg: #ECF0F1;
      --time-bg: #BDC3C7;
      --border: #ddd;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Malgun Gothic", "Apple SD Gothic Neo", sans-serif; background: #ecf0f1; }
    .header {
      background: var(--header-bg);
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .site-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.05em;
    }
    .nav { display: flex; align-items: center; gap: 8px; }
    .nav button {
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #34495e;
      color: #fff;
    }
    .nav button:hover { background: #1abc9c; }
    .nav .week-label { font-size: 16px; font-weight: bold; min-width: 180px; text-align: center; }
    .writers { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .writers span { margin-right: 4px; font-size: 13px; }
    .writers label { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; }
    .writers input { margin-right: 4px; }
    .container { padding: 16px; overflow-x: auto; }
    .grid-wrap { overflow-y: auto; max-height: calc(100vh - 140px); }
    table.calendar { width: 100%; min-width: 900px; border-collapse: collapse; background: #fff; table-layout: fixed; }
    table.calendar th, table.calendar td { border: 1px solid var(--border); padding: 4px; vertical-align: top; }
    table.calendar thead th { position: sticky; top: 0; z-index: 2; box-shadow: 0 1px 0 var(--border); }
    table.calendar th.day-header { background: var(--cell-bg); font-weight: bold; text-align: center; padding: 8px; font-size: 12px; }
    table.calendar th.day-header.today { background: var(--today-bg); }
    table.calendar th.time-col { width: 64px; background: var(--time-bg); font-size: 11px; text-align: center; padding: 8px 4px; min-width: 64px; }
    table.calendar thead th.time-col { position: sticky; top: 0; left: 0; z-index: 3; box-shadow: 2px 0 0 var(--border); }
    table.calendar tbody th.time-col { position: sticky; left: 0; z-index: 1; background: var(--time-bg); box-shadow: 2px 0 0 var(--border); }
    table.calendar td.cell { min-height: 36px; height: 36px; cursor: pointer; transition: background 0.15s; vertical-align: top; }
    table.calendar td.cell:hover { background: #e8f4f8; }
    .event-btn {
      display: block; width: 100%; height: 100%; min-height: 28px; margin: 0; padding: 4px 6px; font-size: 11px; text-align: left;
      border: none; border-radius: 3px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-sizing: border-box;
    }
    .event-btn:hover { opacity: 0.9; filter: brightness(0.95); }
    .event-row-wrap { box-sizing: border-box; min-height: 100%; }
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.show { display: flex; }
    .modal { background: #fff; border-radius: 8px; padding: 20px; min-width: 320px; max-width: 90vw; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .modal h3 { margin-top: 0; margin-bottom: 16px; font-size: 16px; }
    .modal label { display: block; margin-bottom: 4px; font-size: 13px; }
    .modal input[type="text"], .modal select { width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; }
    .modal select { cursor: pointer; }
    .modal .who-group { margin-bottom: 12px; }
    .modal .who-group label { display: inline-flex; margin-right: 8px; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .modal .btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; flex-wrap: wrap; }
    .modal .btns button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .modal .btns .submit { background: #3498db; color: #fff; }
    .modal .btns .submit:hover { background: #2980b9; }
    .modal .btns .cancel { background: #95a5a6; color: #fff; }
    .modal .btns .cancel:hover { background: #7f8c8d; }
    .modal .btns .delete { background: #e74c3c; color: #fff; }
    .modal .btns .delete:hover { background: #c0392b; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background: #27ae60; color: #fff; border-radius: 6px; display: none; z-index: 1001; }
    .toast.show { display: block; }
  </style>
</head>
<body>
  <header class="header">
    <h1 class="site-title">ORGANIZING OUR FAMILY</h1>
    <div class="nav">
      <button type="button" id="btnPrevMonth">&laquo;</button>
      <button type="button" id="btnPrevWeek">&lt;</button>
      <span class="week-label" id="weekLabel"></span>
      <button type="button" id="btnNextWeek">&gt;</button>
      <button type="button" id="btnNextMonth">&raquo;</button>
    </div>
    <div class="writers">
      <span>작성자:</span>
      <label style="background:#BBDEFB;"><input type="radio" name="writer" value="아빠" checked> 아빠</label>
      <label style="background:#F8BBD0;"><input type="radio" name="writer" value="엄마"> 엄마</label>
      <label style="background:#FFE0B2;"><input type="radio" name="writer" value="수현"> 수현</label>
      <label style="background:#C8E6C9;"><input type="radio" name="writer" value="태현"> 태현</label>
    </div>
  </header>

  <div class="container">
    <div class="grid-wrap">
      <table class="calendar" id="calendarTable">
        <thead>
          <tr>
            <th class="time-col">시간</th>
            <th class="day-header" data-day="0"></th>
            <th class="day-header" data-day="1"></th>
            <th class="day-header" data-day="2"></th>
            <th class="day-header" data-day="3"></th>
            <th class="day-header" data-day="4"></th>
            <th class="day-header" data-day="5"></th>
            <th class="day-header" data-day="6"></th>
          </tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </div>
  </div>

  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <h3 id="modalTitle">일정 추가</h3>
      <label>일정 내용</label>
      <input type="text" id="inputContent" placeholder="예: 영어 수업">
      <label>시작 시간 (선택 또는 직접 입력, 예: 13:30)</label>
      <input type="text" id="inputStartTime" list="addStartTimeList" placeholder="06:00 ~ 24:00">
      <datalist id="addStartTimeList"></datalist>
      <label>종료 시간 (선택 또는 직접 입력, 예: 15:00)</label>
      <input type="text" id="inputEndTime" list="addEndTimeList" placeholder="06:00 ~ 24:00">
      <datalist id="addEndTimeList"></datalist>
      <label>메모 (선택)</label>
      <input type="text" id="inputMemo" placeholder="메모">
      <div class="who-group">
        <span>작성자:</span>
        <label style="background:#BBDEFB;"><input type="radio" name="modalWriter" value="아빠" checked> 아빠</label>
        <label style="background:#F8BBD0;"><input type="radio" name="modalWriter" value="엄마"> 엄마</label>
        <label style="background:#FFE0B2;"><input type="radio" name="modalWriter" value="수현"> 수현</label>
        <label style="background:#C8E6C9;"><input type="radio" name="modalWriter" value="태현"> 태현</label>
      </div>
      <div class="btns">
        <button type="button" class="cancel" id="btnModalCancel">취소</button>
        <button type="button" class="submit" id="btnModalSubmit">추가</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3 id="editModalTitle">일정 수정</h3>
      <label>일정 내용</label>
      <input type="text" id="editContent" placeholder="일정 내용">
      <label>메모 (선택)</label>
      <input type="text" id="editMemo" placeholder="메모">
      <label>시작 시간 (선택 또는 직접 입력)</label>
      <input type="text" id="editStartTime" list="editStartTimeList" placeholder="06:00 ~ 24:00">
      <datalist id="editStartTimeList"></datalist>
      <label>종료 시간 (선택 또는 직접 입력)</label>
      <input type="text" id="editEndTime" list="editEndTimeList" placeholder="06:00 ~ 24:00">
      <datalist id="editEndTimeList"></datalist>
      <div class="who-group">
        <span>작성자:</span>
        <label style="background:#BBDEFB;"><input type="radio" name="editWriter" value="아빠"> 아빠</label>
        <label style="background:#F8BBD0;"><input type="radio" name="editWriter" value="엄마"> 엄마</label>
        <label style="background:#FFE0B2;"><input type="radio" name="editWriter" value="수현"> 수현</label>
        <label style="background:#C8E6C9;"><input type="radio" name="editWriter" value="태현"> 태현</label>
      </div>
      <div class="btns">
        <button type="button" class="delete" id="btnEditDelete">삭제</button>
        <button type="button" class="cancel" id="btnEditCancel">취소</button>
        <button type="button" class="submit" id="btnEditSubmit">수정</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const DAYS_KR = ["일", "월", "화", "수", "목", "금", "토"];
    const DAYS_KR_WEEK = ["월", "화", "수", "목", "금", "토", "일"];
    const TIMES = (function() {
      const t = [];
      for (let h = 6; h <= 24; h++) {
        for (let m = 0; m < 60; m += 30) {
          if (h === 24 && m === 30) break;
          t.push(String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0'));
        }
      }
      return t;
    })();
    const MEMBERS = {"아빠":"#BBDEFB","엄마":"#F8BBD0","수현":"#FFE0B2","태현":"#C8E6C9"};

    let viewDate = null;
    let calendarData = {};
    let addCell = null;
    let editingKey = null, editingIndex = null, editingEventId = null;
    let editingDateStr = null, editingStartRow = null;

    function setViewDateToWeekStart(d) {
      const date = new Date(d);
      const day = date.getDay();
      const diff = day === 0 ? date.getDate() - 6 : date.getDate() - (day - 1);
      viewDate = new Date(date.getFullYear(), date.getMonth(), diff, 0, 0, 0, 0);
    }

    function formatDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + day;
    }

    function getWeekLabel() {
      const mid = new Date(viewDate);
      mid.setDate(mid.getDate() + 3);
      const y = mid.getFullYear();
      const m = mid.getMonth() + 1;
      const first = new Date(y, mid.getMonth(), 1);
      const firstSun = first.getDate() - first.getDay();
      const weekNum = Math.ceil((mid.getDate() - firstSun + 1) / 7);
      return y + '년 ' + String(m).padStart(2, '0') + '월 ' + weekNum + '주차';
    }

    function isToday(d) {
      const t = new Date();
      return d.getFullYear() === t.getFullYear() && d.getMonth() === t.getMonth() && d.getDate() === t.getDate();
    }

    async function fetchData() {
      const r = await fetch('/api/data');
      calendarData = await r.json();
      return calendarData;
    }

    function getEventSpan(eventId, dateStr) {
      let startRow = TIMES.length, endRow = 0;
      for (let r = 0; r < TIMES.length; r++) {
        const key = dateStr + '_' + TIMES[r];
        const events = calendarData[key];
        if (events && Array.isArray(events)) {
          for (const ev of events) {
            if (ev && ev.event_id === eventId) {
              if (r < startRow) startRow = r;
              if (r + 1 > endRow) endRow = r + 1;
              break;
            }
          }
        }
      }
      return { startRow: startRow === TIMES.length ? 0 : startRow, endRow: endRow };
    }

    /** 해당 날짜의 모든 이벤트를 (startRow, endRow, ev, keyForBtn, indexInKey) 배열로 반환. 입력 순서 유지. */
    function getEventsForDate(dateStr) {
      const list = [];
      const seen = new Set();
      for (let r = 0; r < TIMES.length; r++) {
        const key = dateStr + '_' + TIMES[r];
        const events = calendarData[key];
        if (!events || !Array.isArray(events)) continue;
        for (let idx = 0; idx < events.length; idx++) {
          const ev = events[idx];
          if (typeof ev !== 'object') continue;
          const eid = ev.event_id || (key + '_' + idx);
          if (seen.has(eid)) continue;
          seen.add(eid);
          const span = ev.event_id ? getEventSpan(ev.event_id, dateStr) : { startRow: r, endRow: r + 1 };
          if (r !== span.startRow) continue;
          list.push({
            startRow: span.startRow,
            endRow: span.endRow,
            ev,
            keyForBtn: key,
            indexInKey: idx
          });
        }
      }
      list.sort(function(a, b) { return a.startRow - b.startRow; });
      return list;
    }

    /** 겹치는 구간에 lane 인덱스 할당. 입력 순서대로 왼쪽(lane 0)부터. */
    function assignLanes(events) {
      const lanes = [];
      for (let i = 0; i < events.length; i++) {
        const e = events[i];
        let lane = 0;
        while (true) {
          let ok = true;
          for (let j = 0; j < i; j++) {
            if (lanes[j] !== lane) continue;
            const o = events[j];
            if (e.startRow < o.endRow && o.startRow < e.endRow) { ok = false; break; }
          }
          if (ok) break;
          lane++;
        }
        lanes.push(lane);
      }
      return lanes;
    }

    /** 해당 요일·해당 행에서 시작하는 이벤트 목록 (lane 없이). */
    function getStartersByRow(events) {
      const byRow = [];
      for (let r = 0; r < TIMES.length; r++) byRow[r] = [];
      for (let k = 0; k < events.length; k++) {
        const item = events[k];
        byRow[item.startRow].push({ startRow: item.startRow, endRow: item.endRow, ev: item.ev, keyForBtn: item.keyForBtn, indexInKey: item.indexInKey });
      }
      return byRow;
    }

    function renderHeaders() {
      const thead = document.querySelector('#calendarTable thead tr');
      const timeCol = thead.querySelector('.time-col');
      thead.innerHTML = '';
      thead.appendChild(timeCol);
      for (let j = 0; j < 7; j++) {
        const d = new Date(viewDate);
        d.setDate(d.getDate() + j);
        const th = document.createElement('th');
        th.className = 'day-header' + (isToday(d) ? ' today' : '');
        th.textContent = DAYS_KR_WEEK[j] + '(' + formatDate(d).slice(5).replace('-', '/') + ')';
        th.setAttribute('data-day', j);
        thead.appendChild(th);
      }
      document.getElementById('weekLabel').textContent = getWeekLabel();
    }

    function renderBody() {
      const tbody = document.getElementById('calendarBody');
      tbody.innerHTML = '';
      const startEvents = [];
      for (let j = 0; j < 7; j++) {
        const d = new Date(viewDate);
        d.setDate(d.getDate() + j);
        const dateStr = formatDate(d);
        const events = getEventsForDate(dateStr);
        startEvents.push(getStartersByRow(events));
      }
      const coveredUntil = [0, 0, 0, 0, 0, 0, 0];

      for (let i = 0; i < TIMES.length; i++) {
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.className = 'time-col';
        th.textContent = TIMES[i];
        tr.appendChild(th);

        for (let j = 0; j < 7; j++) {
          if (i < coveredUntil[j]) continue;

          const d = new Date(viewDate);
          d.setDate(d.getDate() + j);
          const starters = startEvents[j][i] || [];
          const td = document.createElement('td');
          td.className = 'cell';
          td.dataset.row = i;
          td.dataset.col = j;

          if (starters.length === 0) {
            td.rowSpan = 1;
            coveredUntil[j] = i + 1;
          } else {
            let maxSpan = 0;
            for (let s = 0; s < starters.length; s++) {
              const span = starters[s].endRow - starters[s].startRow;
              if (span > maxSpan) maxSpan = span;
            }
            td.rowSpan = maxSpan;
            coveredUntil[j] = i + maxSpan;

            const wrapper = document.createElement('div');
            wrapper.className = 'event-row-wrap';
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'row';
            wrapper.style.height = '100%';
            wrapper.style.width = '100%';
            wrapper.style.gap = '2px';

            for (let s = 0; s < starters.length; s++) {
              const item = starters[s];
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'event-btn';
              btn.textContent = item.ev.text || '';
              btn.style.background = item.ev.bg || '#ddd';
              btn.style.flex = '1';
              btn.style.minWidth = '0';
              btn.dataset.key = item.keyForBtn;
              btn.dataset.index = item.indexInKey;
              btn.dataset.eventId = item.ev.event_id || '';
              btn.addEventListener('click', function(e) { e.stopPropagation(); openEditModal(this); });
              wrapper.appendChild(btn);
            }
            td.appendChild(wrapper);
          }

          td.addEventListener('click', function(e) {
            if (e.target.classList.contains('event-btn')) return;
            openAddModal(parseInt(this.dataset.row, 10), parseInt(this.dataset.col, 10));
          });
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    function parseTimeToIndex(str) {
      if (!str || typeof str !== 'string') return 0;
      var s = str.trim();
      for (var i = 0; i < TIMES.length; i++) {
        if (s === TIMES[i]) return i;
        if (s.length <= 2 && TIMES[i].indexOf(s.padStart(2, '0')) === 0) return i;
      }
      var n = parseInt(s, 10);
      if (!isNaN(n) && n >= 6 && n <= 24) {
        for (var k = 0; k < TIMES.length; k++) {
          if (TIMES[k] === String(n).padStart(2, '0') + ':00') return k;
        }
        return Math.min((n - 6) * 2, TIMES.length - 1);
      }
      return 0;
    }

    function openAddModal(row, col) {
      addCell = { row, col };
      const d = new Date(viewDate);
      d.setDate(d.getDate() + col);
      const dateStr = formatDate(d);
      document.getElementById('modalTitle').textContent = '일정 추가 — ' + dateStr;
      document.getElementById('inputContent').value = '';
      document.getElementById('inputMemo').value = '';
      var startInput = document.getElementById('inputStartTime');
      var endInput = document.getElementById('inputEndTime');
      var startList = document.getElementById('addStartTimeList');
      var endList = document.getElementById('addEndTimeList');
      startList.innerHTML = '';
      endList.innerHTML = '';
      for (var i = 0; i < TIMES.length; i++) {
        var o = document.createElement('option');
        o.value = TIMES[i];
        startList.appendChild(o);
      }
      for (var j = 0; j < TIMES.length; j++) {
        var o2 = document.createElement('option');
        o2.value = TIMES[j];
        endList.appendChild(o2);
      }
      startInput.value = TIMES[row];
      endInput.value = (row + 1 < TIMES.length) ? TIMES[row + 1] : TIMES[row];
      var headerWriter = document.querySelector('input[name="writer"]:checked');
      if (headerWriter) {
        var modalWriter = document.querySelector('input[name="modalWriter"][value="' + headerWriter.value + '"]');
        if (modalWriter) modalWriter.checked = true;
      }
      document.getElementById('addModal').classList.add('show');
      document.getElementById('inputContent').focus();
    }

    function closeAddModal() {
      document.getElementById('addModal').classList.remove('show');
      addCell = null;
    }

    async function submitAdd() {
      if (!addCell) return;
      const content = document.getElementById('inputContent').value.trim();
      if (!content) return;
      const startTimeStr = document.getElementById('inputStartTime').value.trim();
      const endTimeStr = document.getElementById('inputEndTime').value.trim();
      const memo = document.getElementById('inputMemo').value.trim();
      const who = document.querySelector('input[name="modalWriter"]:checked').value;
      const d = new Date(viewDate);
      d.setDate(d.getDate() + addCell.col);
      const dateStr = formatDate(d);

      const res = await fetch('/api/event', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          date_str: dateStr,
          start_time: startTimeStr || undefined,
          time_index: parseTimeToIndex(startTimeStr),
          end_time: endTimeStr,
          who: who,
          content: content,
          memo: memo
        })
      });
      const result = await res.json();
      if (result.ok) {
        calendarData = result.data;
        closeAddModal();
        renderBody();
        showToast('일정이 추가되었습니다.');
      } else {
        showToast('저장 실패.');
      }
    }

    function openEditModal(btn) {
      const key = btn.dataset.key;
      const index = parseInt(btn.dataset.index, 10);
      const eventId = btn.dataset.eventId || '';
      const events = calendarData[key];
      if (!events || !events[index]) return;
      const ev = events[index];

      editingKey = key;
      editingIndex = index;
      editingEventId = eventId || null;

      var content = (ev.text || '').replace(/^[^:]+:\s*/, '').replace(/\s*\(\d{1,2}:\d{2}~\d{1,2}:\d{2}\)\s*$/, '').trim();
      document.getElementById('editContent').value = content;
      document.getElementById('editMemo').value = ev.memo || '';
      var dateStr = key.substring(0, 10);
      var startTimeVal = '';
      var endTimeVal = '';
      if (eventId) {
        var span = getEventSpan(eventId, dateStr);
        editingDateStr = dateStr;
        editingStartRow = span.startRow;
        startTimeVal = TIMES[span.startRow] || '';
        endTimeVal = (span.endRow < TIMES.length) ? TIMES[span.endRow] : TIMES[TIMES.length - 1];
      } else {
        var timePart = key.length > 10 ? key.substring(11) : '';
        var slotRow = TIMES.indexOf(timePart) >= 0 ? TIMES.indexOf(timePart) : 0;
        editingStartRow = slotRow;
        startTimeVal = TIMES[slotRow] || '';
        endTimeVal = slotRow + 1 < TIMES.length ? TIMES[slotRow + 1] : TIMES[slotRow];
      }
      var editStartInput = document.getElementById('editStartTime');
      var editEndInput = document.getElementById('editEndTime');
      var editStartList = document.getElementById('editStartTimeList');
      var editEndList = document.getElementById('editEndTimeList');
      editStartList.innerHTML = '';
      editEndList.innerHTML = '';
      for (var i = 0; i < TIMES.length; i++) {
        var o = document.createElement('option');
        o.value = TIMES[i];
        editStartList.appendChild(o);
      }
      for (var j = 0; j < TIMES.length; j++) {
        var o2 = document.createElement('option');
        o2.value = TIMES[j];
        editEndList.appendChild(o2);
      }
      editStartInput.value = startTimeVal;
      editEndInput.value = endTimeVal;
      var editWriterEl = document.querySelector('input[name="editWriter"][value="' + (ev.who || '아빠') + '"]');
      if (editWriterEl) editWriterEl.checked = true;

      document.getElementById('editModal').classList.add('show');
      document.getElementById('editContent').focus();
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      editingKey = null;
      editingIndex = null;
      editingEventId = null;
      editingDateStr = null;
      editingStartRow = null;
    }

    async function submitEdit() {
      if (!editingKey) return;
      const content = document.getElementById('editContent').value.trim();
      if (!content) return;
      const who = document.querySelector('input[name="editWriter"]:checked').value;
      const memo = document.getElementById('editMemo').value.trim();
      const startTimeStr = document.getElementById('editStartTime').value.trim();
      const endTimeStr = document.getElementById('editEndTime').value.trim();
      const payload = {
        key: editingKey,
        index: editingIndex,
        event_id: editingEventId || undefined,
        content: content,
        who: who,
        memo: memo
      };
      if (editingEventId && editingDateStr != null) {
        payload.date_str = editingDateStr;
        payload.start_time = startTimeStr;
        payload.start_time_index = parseTimeToIndex(startTimeStr);
        payload.end_time = endTimeStr;
      }
      const res = await fetch('/api/event/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      if (result.ok) {
        calendarData = result.data;
        closeEditModal();
        renderBody();
        showToast('일정이 수정되었습니다.');
      } else {
        showToast('수정 실패.');
      }
    }

    async function deleteFromEditModal() {
      if (!confirm('선택한 일정을 삭제할까요?')) return;
      const key = editingKey;
      const index = editingIndex;
      const eventId = editingEventId || '';

      const res = await fetch('/api/event/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(eventId ? { event_id: eventId } : { key, index })
      });
      const result = await res.json();
      if (result.ok) {
        calendarData = result.data;
        closeEditModal();
        renderBody();
        showToast('삭제되었습니다.');
      } else {
        showToast('삭제 실패.');
      }
    }

    async function deleteEvent(btn) {
      const key = btn.dataset.key;
      const index = parseInt(btn.dataset.index, 10);
      const eventId = btn.dataset.eventId || '';
      if (!confirm('선택한 일정을 삭제할까요?')) return;

      const res = await fetch('/api/event/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(eventId ? { event_id: eventId } : { key, index })
      });
      const result = await res.json();
      if (result.ok) {
        calendarData = result.data;
        renderBody();
        showToast('삭제되었습니다.');
      } else {
        showToast('삭제 실패.');
      }
    }

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(function() { el.classList.remove('show'); }, 2000);
    }

    function goPrevWeek() { viewDate.setDate(viewDate.getDate() - 7); renderHeaders(); renderBody(); }
    function goNextWeek() { viewDate.setDate(viewDate.getDate() + 7); renderHeaders(); renderBody(); }
    function goPrevMonth() { viewDate.setMonth(viewDate.getMonth() - 1); renderHeaders(); renderBody(); }
    function goNextMonth() { viewDate.setMonth(viewDate.getMonth() + 1); renderHeaders(); renderBody(); }

    document.getElementById('btnPrevMonth').addEventListener('click', goPrevMonth);
    document.getElementById('btnPrevWeek').addEventListener('click', goPrevWeek);
    document.getElementById('btnNextWeek').addEventListener('click', goNextWeek);
    document.getElementById('btnNextMonth').addEventListener('click', goNextMonth);
    document.getElementById('btnModalCancel').addEventListener('click', closeAddModal);
    document.getElementById('btnModalSubmit').addEventListener('click', submitAdd);
    document.getElementById('inputContent').addEventListener('keydown', function(e) { if (e.key === 'Enter') submitAdd(); });
    document.getElementById('btnEditCancel').addEventListener('click', closeEditModal);
    document.getElementById('btnEditSubmit').addEventListener('click', submitEdit);
    document.getElementById('btnEditDelete').addEventListener('click', deleteFromEditModal);
    document.getElementById('editContent').addEventListener('keydown', function(e) { if (e.key === 'Enter') submitEdit(); });

    (async function init() {
      setViewDateToWeekStart(new Date());
      await fetchData();
      renderHeaders();
      renderBody();
    })();
  </script>
</body>
</html>

